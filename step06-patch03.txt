#!/bin/bash
set -e

echo "üîß Aplicando o Ajuste Final no KanbanController..."

cat << 'EOF' > apps/api/src/kanban/kanban.controller.ts
import { Controller, Get, Post, Body, Patch, Param, Request } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { EventsGateway } from '../events/events.gateway';

// Traduz o n√∫mero decimal (ex: 1000) para String Lexicogr√°fica (ex: "000000000000001000.00000")
function toRank(order: number): string {
  return Number(order || 0).toFixed(5).padStart(20, '0');
}

@Controller('kanban')
export class KanbanController {
  constructor(private prisma: PrismaService, private events: EventsGateway) {}

  @Get('board/:id')
  async getBoard(@Param('id') id: string) {
    const board = await this.prisma.board.findUnique({
      where: { id },
      include: {
        lists: {
          include: { cards: { orderBy: { rank: 'asc' } } },
          orderBy: { rank: 'asc' }
        }
      }
    });

    if (!board) return null;

    return {
      ...board,
      columns: board.lists.map((list: any) => ({
        id: list.id,
        title: list.title,
        order: parseFloat(list.rank),
        boardId: list.boardId,
        tasks: list.cards.map((card: any) => ({
          id: card.id,
          title: card.title,
          order: parseFloat(card.rank),
          columnId: card.listId
        }))
      }))
    };
  }

  @Post('columns')
  async createColumn(@Body() body: { title: string; boardId: string; order: number }) {
    const list = await this.prisma.list.create({
      data: { 
        title: body.title, 
        boardId: body.boardId, 
        rank: toRank(body.order) 
      }
    });
    this.events.server.emit('boardUpdated', { boardId: list.boardId });
    return { id: list.id, title: list.title, order: parseFloat(list.rank), boardId: list.boardId };
  }

  @Post('tasks')
  async createTask(@Request() req: any, @Body() body: { title: string; columnId: string; order: number }) {
    const list = await this.prisma.list.findUnique({ where: { id: body.columnId } });
    if (!list) return null;

    // Fallback de seguran√ßa para garantir a associa√ß√£o do cart√£o a um usu√°rio real
    let userId = req.user?.id || req.user?.sub;
    if (!userId) {
      const fallbackUser = await this.prisma.user.findFirst();
      userId = fallbackUser?.id || 'unknown';
    }

    const card = await this.prisma.card.create({
      data: { 
        title: body.title, 
        listId: body.columnId, 
        rank: toRank(body.order),
        boardId: list.boardId,
        createdById: userId,
        status: 'TODO' // <-- Prisma satisfeito!
      }
    });
    
    this.events.server.emit('boardUpdated', { boardId: list.boardId });
    return { id: card.id, title: card.title, order: parseFloat(card.rank), columnId: card.listId };
  }

  @Patch('tasks/:id')
  async updateTask(@Param('id') id: string, @Body() body: { columnId?: string; order?: number }) {
    const data: any = {};
    if (body.columnId) data.listId = body.columnId;
    if (body.order !== undefined) data.rank = toRank(body.order);

    const card = await this.prisma.card.update({ where: { id }, data });
    
    this.events.server.emit('boardUpdated', { boardId: card.boardId });
    return { id: card.id, title: card.title, order: parseFloat(card.rank), columnId: card.listId };
  }
}
EOF

echo "üèóÔ∏è Recompilando o Backend API..."
cd apps/api
pnpm run build
cd ../..

echo ""
echo "‚úÖ=========================================================="
echo "üéØ PROBLEMAS 100% RESOLVIDOS!"
echo "API compilada com sucesso e pronta para a M√°gica."
echo "‚úÖ=========================================================="